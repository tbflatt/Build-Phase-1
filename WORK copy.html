<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SBSB | Who Does What</title>

  <!-- Favicon -->
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="img/apple-touch-icon.png" />

  <!-- Web Fonts  -->
  <link id="googleFonts"
        href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800%7CShadows+Into+Light%7CPlayfair+Display:400&display=swap"
        rel="stylesheet" type="text/css">

  <!-- Vendor CSS -->
  <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="vendor/fontawesome-free/css/all.min.css">
  <link rel="stylesheet" href="vendor/animate/animate.compat.css">
  <link rel="stylesheet" href="vendor/simple-line-icons/css/simple-line-icons.min.css">
  <link rel="stylesheet" href="vendor/owl.carousel/assets/owl.carousel.min.css">
  <link rel="stylesheet" href="vendor/owl.carousel/assets/owl.theme.default.min.css">
  <link rel="stylesheet" href="vendor/magnific-popup/magnific-popup.min.css">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/theme-elements.css">
  <link rel="stylesheet" href="css/theme-blog.css">
  <link rel="stylesheet" href="css/theme-shop.css">

  <!-- Skin CSS -->
  <link id="skinCSS" rel="stylesheet" href="css/skins/default.css">

  <!-- Theme Custom CSS -->
  <link rel="stylesheet" href="css/custom.css">

  <style>
    .header-logo img { width: 90px; height: auto; transition: width 0.3s, height 0.3s; }
    #header.header-effect-shrink .header-logo img { width: 90px; height: auto; }

    .wdw-search .form-control {
      border-radius: 999px;
      padding-left: 2.75rem;
    }
    .wdw-search .fa-search {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      opacity: 0.6;
    }
    .badge-office {
      font-weight: 600;
      letter-spacing: .2px;
    }
    .table thead th {
      white-space: nowrap;
    }
    .muted-note {
      color: rgba(0,0,0,.6);
    }
  </style>
</head>

<body data-plugin-page-transition>
<div class="body">

  <!-- ===== Header (copied pattern from your existing pages) ===== -->
  <header id="header" class="header-effect-shrink"
          data-plugin-options="{'stickyEnabled': true, 'stickyEffect': 'shrink', 'stickyEnableOnBoxed': true, 'stickyEnableOnMobile': false, 'stickyChangeLogo': true, 'stickyStartAt': 30, 'stickyHeaderContainerHeight': 70}">
    <div class="header-body">
      <div class="header-container container">
        <div class="header-row">
          <div class="header-column">
            <div class="header-row">
              <div class="header-logo">
                <a href="index.html">
                  <img alt="SBSB" style="width: 90px; height: auto;" data-sticky-width="90" data-sticky-height="90" src="SBSB-logo.png">
                </a>
              </div>
            </div>
          </div>

          <div class="header-column justify-content-end">
            <div class="header-row">
              <div class="header-nav header-nav-line header-nav-top-line header-nav-top-line-with-border order-2 order-lg-1">
                <div class="header-nav-main header-nav-main-square header-nav-main-effect-2 header-nav-main-sub-effect-1">
                  <nav class="collapse">
                    <ul class="nav nav-pills" id="mainNav">
                      <li class="dropdown">
                        <a class="dropdown-item dropdown-toggle" href="index.html">Home</a>
                      </li>

                      <li class="dropdown">
                        <a class="dropdown-item dropdown-toggle" href="#">Support</a>
                        <ul class="dropdown-menu">
                          <li>
                            <a class="dropdown-item" href="https://helpdesk.sbsb-eastham.com/" target="_blank">IT Ticket</a>
                          </li>
                          <li><a class="dropdown-item" href="osr.html">Office Service Request</a></li>
                          <li><a class="dropdown-item" href="conf.html">Conf. Room Request</a></li>
                        </ul>
                      </li>

                      <li class="dropdown">
                        <a class="dropdown-item dropdown-toggle" href="#">Directory</a>
                        <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="extension.html">Extension List</a></li>
                          <li><a class="dropdown-item" href="visual.html">Visual Directory</a></li>
                          <li><a class="dropdown-item" href="orgchart.html">Org Chart</a></li>
                        </ul>
                      </li>

                      <li class="dropdown">
                        <a class="dropdown-item dropdown-toggle" href="event calendar.html">Events</a>
                      </li>

                      <li class="dropdown">
                        <a class="dropdown-item dropdown-toggle active" href="who-does-what.html">Who Does What</a>
                      </li>

                      <li class="dropdown">
                        <a class="dropdown-item dropdown-toggle" href="#">Galleries</a>
                        <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="gallery.html">Christmas Party 2024</a></li>
                        </ul>
                      </li>
                    </ul>
                  </nav>
                </div>
                <button class="btn header-btn-collapse-nav" data-bs-toggle="collapse" data-bs-target=".header-nav-main nav">
                  <i class="fas fa-bars"></i>
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </header>
  <!-- ===== /Header ===== -->

  <div role="main" class="main">
    <section class="page-header page-header-modern page-header-md bg-color-light">
      <div class="container">
        <div class="row align-items-center">
          <div class="col">
            <h1 class="text-8 font-weight-bold mb-0">Who Does What</h1>
            <p class="mb-0 muted-note">Search an issue/topic to find the right team & contact.</p>
          </div>
        </div>
      </div>
    </section>

    <div class="container py-4">

      <div class="card mb-4">
        <div class="card-body">

          <div class="row align-items-center g-3">
            <div class="col-lg-7">
              <div class="position-relative wdw-search">
                <i class="fas fa-search"></i>
                <input id="wdwSearch" type="text" class="form-control form-control-lg"
                       placeholder="Search (ex: keycard, PTO, WestLaw, phone issues, FedEx, onboarding...)">
              </div>
              <div class="small muted-note mt-2">
                Tip: search by <strong>topic</strong>, <strong>department</strong>, <strong>contact name</strong>, or <strong>office</strong>.
              </div>
            </div>

            <div class="col-lg-5">
              <div class="d-flex flex-wrap gap-2 justify-content-lg-end">
                <button class="btn btn-outline-primary btn-sm wdw-office" data-office="ALL">ALL</button>
                <button class="btn btn-outline-primary btn-sm wdw-office" data-office="HOU">HOU</button>
                <button class="btn btn-outline-primary btn-sm wdw-office" data-office="DALLAS">DALLAS</button>
                <button class="btn btn-outline-primary btn-sm wdw-office" data-office="CORPUS CHRISTI">CORPUS CHRISTI</button>
                <button class="btn btn-outline-primary btn-sm wdw-office" data-office="NEW ORLEANS">NEW ORLEANS</button>
              </div>
              <div class="small muted-note mt-2 text-lg-end">
                Office filter is optional — search still works without it.
              </div>
            </div>
          </div>

          <hr class="my-4" />

          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="bg-light">
                <tr>
                  <th style="min-width: 260px;">Issue / Topic</th>
                  <th style="min-width: 120px;">Office</th>
                  <th style="min-width: 220px;">Responsible Department</th>
                  <th style="min-width: 240px;">Contact</th>
                  <th style="min-width: 260px;">Notes</th>
                </tr>
              </thead>
              <tbody id="wdwTbody">
                <!-- rows inserted by JS -->
              </tbody>
            </table>
          </div>

          <div id="wdwEmpty" class="alert alert-light border mt-4 d-none">
            <strong>No matches.</strong> Try a different keyword (ex: “PTO”, “keycard”, “phone”, “WestLaw”, “billing”, “supplies”).
          </div>

        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h3 class="text-5 mb-2">Need to add something?</h3>
          <p class="mb-0">
            Add or edit items inside the <code>WDW_DATA</code> array at the bottom of this page.
            If you want, I can also convert your Word doc into the same structure so it’s “single source of truth.”
          </p>
        </div>
      </div>

    </div>
  </div>

  <!-- ===== Footer (your existing style) ===== -->
  <footer id="footer" class="mt-0">
    <div class="footer-copyright">
      <div class="container py-2">
        <div class="row py-4">
          <div class="col-lg-1 d-flex align-items-center justify-content-center justify-content-lg-start mb-2 mb-lg-0">
            <a href="index.html" class="logo pe-0 pe-lg-3">
              <img alt="SBSB Website" src="SBSB-logo.png" class="opacity-7" height="50">
            </a>
          </div>
          <div class="col-lg-7 d-flex align-items-center justify-content-center justify-content-lg-start mb-4 mb-lg-0">
            <p>SBSB-EASTHAM 2025</p>
          </div>
          <div class="col-lg-4 d-flex align-items-center justify-content-center justify-content-lg-end"></div>
        </div>
      </div>
    </div>
  </footer>
  <!-- ===== /Footer ===== -->

</div>

<!-- Vendor -->
<script src="vendor/plugins/js/plugins.min.js"></script>

<!-- Theme Base, Components and Settings -->
<script src="js/theme.js"></script>

<!-- Theme Custom -->
<script src="js/custom.js"></script>

<!-- Theme Initialization Files -->
<script src="js/theme.init.js"></script>

<!-- Scroll top -->
<a id="scrollTop"><i class="icon-chevron-up"></i><i class="icon-chevron-up"></i></a>

<script>
let selectedOffice = "ALL";
let WDW_DATA = []; // filled from TXT

function normalize(str) {
  return (str || "").toString().toLowerCase().trim();
}

function safe(val) {
  return (val && val.toString().trim()) ? val : "<span class='muted-note'>—</span>";
}

function officeBadge(office) {
  const o = (office || "").trim().toUpperCase();
  const isAll = o === "ALL";
  const cls = isAll ? "bg-success" : "bg-primary";
  return `<span class="badge ${cls} badge-office">${o || "-"}</span>`;
}

function renderRows() {
  const q = normalize(document.getElementById("wdwSearch").value);
  const tbody = document.getElementById("wdwTbody");
  const empty = document.getElementById("wdwEmpty");

  let rows = WDW_DATA.slice();

  // office filter (ALL is always eligible)
  if (selectedOffice !== "ALL") {
    rows = rows.filter(r => {
      const ro = (r.office || "").toUpperCase().trim();
      return ro === "ALL" || ro === selectedOffice;
    });
  }

  // search filter across all fields
  if (q) {
    rows = rows.filter(r => {
      const hay = [r.topic, r.office, r.dept, r.contact, r.notes]
        .map(normalize)
        .join(" | ");
      return hay.includes(q);
    });
  }

  tbody.innerHTML = rows.map(r => `
    <tr>
      <td><strong>${safe(r.topic)}</strong></td>
      <td>${officeBadge(r.office)}</td>
      <td>${safe(r.dept)}</td>
      <td>${formatContact(r.contact)}</td>
      <td>${safe(r.notes)}</td>
    </tr>
  `).join("");

  empty.classList.toggle("d-none", rows.length !== 0);
}

function formatContact(contact) {
  const c = (contact || "").toString().trim();
  if (!c) return "<span class='muted-note'>—</span>";

  // make emails clickable if the entire field is an email
  const emailMatch = c.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/);
  if (emailMatch) return `<a href="mailto:${c}">${c}</a>`;

  // if it contains multiple emails inside text, link them too (lightweight)
  return c.replace(/[^\s@]+@[^\s@]+\.[^\s@]+/g, (email) => `<a href="mailto:${email}">${email}</a>`);
}

function parseTSV(text) {
  const lines = text
    .split(/\r?\n/)
    .map(l => l.trimEnd())
    .filter(l => l.trim() && !l.trim().startsWith("#"));

  if (lines.length === 0) return [];

  // Expect header row then data rows
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const parts = lines[i].split("\t");

    rows.push({
      topic: (parts[0] || "").trim(),
      office: (parts[1] || "").trim(),
      dept: (parts[2] || "").trim(),
      contact: (parts[3] || "").trim(),
      notes: (parts[4] || "").trim()
    });
  }
  return rows;
}

async function loadData() {
  // cache-bust so edits show up without hard refresh
  const res = await fetch("who-does-what.txt?v=" + Date.now(), { cache: "no-store" });
  if (!res.ok) throw new Error("Failed to load who-does-what.txt (" + res.status + ")");
  const text = await res.text();
  WDW_DATA = parseTSV(text);
  renderRows();
}

document.addEventListener("DOMContentLoaded", async () => {
  // Search input
  document.getElementById("wdwSearch").addEventListener("input", renderRows);

  // Office buttons
  document.querySelectorAll(".wdw-office").forEach(btn => {
    btn.addEventListener("click", () => {
      selectedOffice = btn.getAttribute("data-office").toUpperCase().trim();
      document.querySelectorAll(".wdw-office").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      renderRows();
    });
  });

  const allBtn = document.querySelector('.wdw-office[data-office="ALL"]');
  if (allBtn) allBtn.classList.add("active");

  // Load TXT
  try {
    await loadData();
  } catch (e) {
    console.error(e);
    document.getElementById("wdwEmpty").classList.remove("d-none");
    document.getElementById("wdwEmpty").classList.add("alert-danger");
    document.getElementById("wdwEmpty").innerHTML =
      "<strong>Could not load who-does-what.txt</strong><br>" +
      "<span class='small'>" + (e.message || "Unknown error") + "</span>";
  }

  // Optional: re-fetch every 2 minutes (true “near real-time” updates)
  // setInterval(loadData, 120000);
});
</script>


</body>
</html>
