<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SBSB | Who Does What</title>

  <!-- Favicon (optional) -->
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="img/apple-touch-icon.png" />

  <!-- Vendor CSS -->
  <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="vendor/fontawesome-free/css/all.min.css">

  <!-- Theme CSS -->
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/theme-elements.css">
  <link id="skinCSS" rel="stylesheet" href="css/skins/default.css">
  <link rel="stylesheet" href="css/custom.css">

  <style>
    .wdw-search .form-control { border-radius: 999px; padding-left: 2.75rem; }
    .wdw-search .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); opacity: .6; }
    .badge-office { font-weight: 600; letter-spacing: .2px; }
    .muted-note { color: rgba(0,0,0,.65); }
    .table thead th { white-space: nowrap; }

    .wdw-contact {
      text-decoration: underline;
      text-underline-offset: 2px;
      cursor: pointer;
    }
    .wdw-contact:hover { opacity: .9; }

    /* Make popovers a bit wider for phone/email */
    .popover { max-width: 340px; }
  </style>
</head>

<body data-plugin-page-transition>
<div class="body">

  <!-- ===== Optional: Paste your existing header/nav here ===== -->
  <!-- Keeping it minimal to avoid conflicting scripts.
       If you paste your site's full header, leave the scripts at the bottom intact. -->
  <!-- ===== /Header ===== -->

  <div role="main" class="main">
    <section class="page-header page-header-modern page-header-md bg-color-light">
      <div class="container">
        <div class="row align-items-center">
          <div class="col">
            <h1 class="text-8 font-weight-bold mb-0">Who Does What</h1>
            <p class="mb-0 muted-note">Search an issue/topic to find the right department and contact.</p>
          </div>
        </div>
      </div>
    </section>

    <div class="container py-4">

      <div class="card mb-4">
        <div class="card-body">

          <div class="row align-items-center g-3">
            <div class="col-lg-7">
              <div class="position-relative wdw-search">
                <i class="fas fa-search"></i>
                <input id="wdwSearch" type="text" class="form-control form-control-lg"
                       placeholder="Search (ex: keycard, PTO, WestLaw, FedEx, billing, tech...)">
              </div>
              <div class="small muted-note mt-2">
                Tip: search by <strong>topic</strong>, <strong>department</strong>, <strong>contact name</strong>, or <strong>office</strong>.
                Hover/click a name to see extension/phone/email.
              </div>
            </div>

            <div class="col-lg-5">
  <div class="d-flex justify-content-lg-end">
    <div style="min-width: 220px;">
      <label for="officeSelect" class="form-label mb-1 fw-semibold">
        Office
      </label>
      <select id="officeSelect" class="form-select">
        <option value="ALL">All Offices</option>
        <option value="HOU">Houston</option>
        <option value="DALLAS">Dallas</option>
        <option value="CORPUS CHRISTI">Corpus Christi</option>
        <option value="NEW ORLEANS">New Orleans</option>
      </select>
    </div>
  </div>

  <div class="small muted-note mt-2 text-lg-end">
    Data loaded from <code>who-does-what.json</code>
  </div>
</div>


          <hr class="my-4" />

          <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
            <div class="small muted-note">
              <span id="wdwCount">0</span> result(s)
              <span class="mx-2">•</span>
              Last updated: <span id="wdwUpdated" class="fw-semibold">—</span>
            </div>

            <div class="d-flex gap-2">
              <button id="wdwReload" class="btn btn-light btn-sm border">
                <i class="fas fa-sync-alt me-1"></i> Reload
              </button>
            </div>
          </div>

          <div class="table-responsive mt-3">
            <table class="table table-hover align-middle mb-0">
              <thead class="bg-light">
                <tr>
                  <th style="min-width: 260px;">Issue / Topic</th>
                  <th style="min-width: 120px;">Office</th>
                  <th style="min-width: 220px;">Responsible Department</th>
                  <th style="min-width: 260px;">Contact</th>
                  <th style="min-width: 280px;">Notes</th>
                </tr>
              </thead>
              <tbody id="wdwTbody"></tbody>
            </table>
          </div>

          <div id="wdwEmpty" class="alert alert-light border mt-4 d-none">
            <strong>No matches.</strong> Try a different keyword.
          </div>

          <div id="wdwError" class="alert alert-danger mt-4 d-none"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Vendor / Theme JS -->
<script src="vendor/plugins/js/plugins.min.js"></script>
<script src="js/theme.js"></script>
<script src="js/custom.js"></script>
<script src="js/theme.init.js"></script>

<script>
/**
 * Expects who-does-what.json in this structure:
 * {
 *   "updated": "YYYY-MM-DD",
 *   "people": { "id": { "name": "...", "ext": "...", "phone": "...", "email": "..." }, ... },
 *   "items": [ { "topic": "...", "office": "...", "dept": "...", "personRefs": ["id","id"], "notes": "..." }, ... ]
 * }
 */

let selectedOffice = "ALL";
let WDW_UPDATED = "—";
let PEOPLE = {};
let ITEMS = [];

// ---------- helpers ----------
function normalize(str) {
  return (str || "").toString().toLowerCase().trim();
}

function escapeHtml(s) {
  return (s || "").toString()
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function safe(val) {
  return (val && val.toString().trim()) ? escapeHtml(val) : "<span class='muted-note'>—</span>";
}

function officeBadge(office) {
  const o = (office || "").trim().toUpperCase();
  const isAll = o === "ALL";
  const cls = isAll ? "bg-success" : "bg-primary";
  return `<span class="badge ${cls} badge-office">${escapeHtml(o || "-")}</span>`;
}

function buildPopoverContent(person) {
  const ext = person.ext ? `<div><strong>Ext:</strong> ${escapeHtml(person.ext)}</div>` : "";
  const phone = person.phone ? `<div><strong>Phone:</strong> ${escapeHtml(person.phone)}</div>` : "";
  const email = person.email
    ? `<div><strong>Email:</strong> <a href="mailto:${escapeHtml(person.email)}">${escapeHtml(person.email)}</a></div>`
    : "";

  const body = [ext, phone, email].filter(Boolean).join("");
  return body || `<div class="muted-note">No extension/phone on file.</div>`;
}

function renderContacts(personRefs) {
  if (!Array.isArray(personRefs) || personRefs.length === 0) {
    return "<span class='muted-note'>—</span>";
  }

  return personRefs.map((id, idx) => {
    const p = PEOPLE[id];
    if (!p) {
      const unknown = escapeHtml(id);
      return `<span class="muted-note">${unknown}</span>${idx < personRefs.length - 1 ? "<span>, </span>" : ""}`;
    }

    const name = escapeHtml(p.name || "Contact");
    const content = escapeHtml(buildPopoverContent(p)); // escape to safely store in attribute

    return `
      <a href="javascript:void(0)"
         class="wdw-contact"
         data-bs-toggle="popover"
         data-bs-trigger="hover focus"
         data-bs-placement="auto"
         data-bs-html="true"
         data-bs-title="${name}"
         data-bs-content="${content}">
        ${name}
      </a>${idx < personRefs.length - 1 ? "<span>, </span>" : ""}`;
  }).join("");
}

function initPopovers() {
  // Requires bootstrap Popover available (Bootstrap 5)
  if (typeof bootstrap === "undefined" || !bootstrap.Popover) return;

  // Dispose old popovers to prevent duplicates after re-render
  document.querySelectorAll(".wdw-contact").forEach(el => {
    const existing = bootstrap.Popover.getInstance(el);
    if (existing) existing.dispose();
  });

  document.querySelectorAll(".wdw-contact").forEach(el => {
    new bootstrap.Popover(el, {
      container: "body",
      trigger: "hover focus",
      placement: "auto",
      html: true
    });
  });
}

// ---------- rendering ----------
function renderRows() {
  const q = normalize(document.getElementById("wdwSearch").value);
  const tbody = document.getElementById("wdwTbody");
  const empty = document.getElementById("wdwEmpty");

  let rows = ITEMS.slice();

  // Office filter (ALL entries always eligible)
  if (selectedOffice !== "ALL") {
    rows = rows.filter(r => {
      const ro = (r.office || "").toUpperCase().trim();
      return ro === "ALL" || ro === selectedOffice;
    });
  }

  // Search filter across topic/office/dept/notes + resolved people fields
  if (q) {
    rows = rows.filter(r => {
      const peopleText = (Array.isArray(r.personRefs) ? r.personRefs : [])
        .map(id => {
          const p = PEOPLE[id] || {};
          return [p.name, p.email, p.ext, p.phone].filter(Boolean).join(" ");
        })
        .join(" | ");

      const hay = [
        r.topic, r.office, r.dept, r.notes, peopleText
      ].map(normalize).join(" | ");

      return hay.includes(q);
    });
  }

  tbody.innerHTML = rows.map(r => `
    <tr>
      <td><strong>${safe(r.topic)}</strong></td>
      <td>${officeBadge(r.office)}</td>
      <td>${safe(r.dept)}</td>
      <td>${renderContacts(r.personRefs)}</td>
      <td>${safe(r.notes)}</td>
    </tr>
  `).join("");

  document.getElementById("wdwCount").textContent = rows.length.toString();
  document.getElementById("wdwUpdated").textContent = WDW_UPDATED;

  empty.classList.toggle("d-none", rows.length !== 0);

  initPopovers();
}

// ---------- data load ----------
async function loadData() {
  const errBox = document.getElementById("wdwError");
  errBox.classList.add("d-none");
  errBox.textContent = "";

  const url = "who-does-what.json?v=" + Date.now(); // cache-bust for fast edits
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error("Failed to load who-does-what.json (" + res.status + ")");

  const json = await res.json();
  if (!json || typeof json !== "object") throw new Error("Invalid JSON (not an object)");
  if (!json.people || typeof json.people !== "object") throw new Error("Invalid JSON: missing 'people' object");
  if (!Array.isArray(json.items)) throw new Error("Invalid JSON: missing 'items' array");

  PEOPLE = json.people;
  ITEMS = json.items;
  WDW_UPDATED = json.updated || "—";

  renderRows();
}

// ---------- init ----------
document.addEventListener("DOMContentLoaded", async () => {
  document.getElementById("wdwSearch").addEventListener("input", renderRows);

const officeSelect = document.getElementById("officeSelect");

officeSelect.addEventListener("change", () => {
  selectedOffice = officeSelect.value.toUpperCase().trim();
  renderRows();
});

// default selection
officeSelect.value = "ALL";

  document.getElementById("wdwReload").addEventListener("click", loadData);

  try {
    await loadData();
  } catch (e) {
    console.error(e);
    const errBox = document.getElementById("wdwError");
    errBox.classList.remove("d-none");
    errBox.innerHTML =
      "<strong>Could not load who-does-what.json</strong><br>" +
      "<span class='small'>" + escapeHtml(e.message || "Unknown error") + "</span>";
  }

  // Optional: auto refresh every 2 minutes
  // setInterval(loadData, 120000);
});
</script>

</body>
</html>
